/*
 * oled_display.c
 *
 *  Created on: Jul 7, 2025
 *      Author: makar
 */
#define OLED_RES_SET()		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_2, SET)
#define OLED_DC_SET()		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_3, SET)
#define OLED_CS_SET()		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, SET)

#define OLED_RES_RESET()    HAL_GPIO_WritePin(GPIOA, GPIO_PIN_2, RESET)
#define OLED_DC_RESET()		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_3, RESET)
#define OLED_CS_RESET()		HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, RESET)

#define WIDTH 				128
#define HEIGHT 				64
#define PAGE_COUNT 			8
#define SYMBOL_7x4_COLMNS	5
#define FIRST_SYMBOL_ID		32
#define LAST_SYMBOL_ID		128

#include "oled_display.h"
#include <string.h>

static const uint8_t symbols[96][5] = {
		{ 0x00, 0x00, 0x00, 0x00, 0x00 }, // ' ' (space)
		{ 0x00, 0x00, 0x5F, 0x00, 0x00 }, // '!'
		{ 0x00, 0x07, 0x00, 0x07, 0x00 }, // '"'
		{ 0x14, 0x7F, 0x14, 0x7F, 0x14 }, // '#'
		{ 0x24, 0x2A, 0x7F, 0x2A, 0x12 }, // '$'
		{ 0x23, 0x13, 0x08, 0x64, 0x62 }, // '%'
		{ 0x36, 0x49, 0x55, 0x22, 0x50 }, // '&'
		{ 0x00, 0x05, 0x03, 0x00, 0x00 }, // '''
		{ 0x00, 0x1C, 0x22, 0x41, 0x00 }, // '('
		{ 0x00, 0x41, 0x22, 0x1C, 0x00 }, // ')'
		{ 0x14, 0x08, 0x3E, 0x08, 0x14 }, // '*'
		{ 0x08, 0x08, 0x3E, 0x08, 0x08 }, // '+'
		{ 0x00, 0x50, 0x30, 0x00, 0x00 }, // ','
		{ 0x08, 0x08, 0x08, 0x08, 0x08 }, // '-'
		{ 0x00, 0x60, 0x60, 0x00, 0x00 }, // '.'
		{ 0x20, 0x10, 0x08, 0x04, 0x02 }, // '/'
		{ 0x3E, 0x51, 0x49, 0x45, 0x3E }, // '0'
		{ 0x00, 0x42, 0x7F, 0x40, 0x00 }, // '1'
		{ 0x42, 0x61, 0x51, 0x49, 0x46 }, // '2'
		{ 0x21, 0x41, 0x45, 0x4B, 0x31 }, // '3'
		{ 0x18, 0x14, 0x12, 0x7F, 0x10 }, // '4'
		{ 0x27, 0x45, 0x45, 0x45, 0x39 }, // '5'
		{ 0x3C, 0x4A, 0x49, 0x49, 0x30 }, // '6'
		{ 0x01, 0x71, 0x09, 0x05, 0x03 }, // '7'
		{ 0x36, 0x49, 0x49, 0x49, 0x36 }, // '8'
		{ 0x06, 0x49, 0x49, 0x29, 0x1E }, // '9'
		{ 0x00, 0x36, 0x36, 0x00, 0x00 }, // ':'
		{ 0x00, 0x56, 0x36, 0x00, 0x00 }, // ';'
		{ 0x08, 0x14, 0x22, 0x41, 0x00 }, // '<'
		{ 0x14, 0x14, 0x14, 0x14, 0x14 }, // '='
		{ 0x00, 0x41, 0x22, 0x14, 0x08 }, // '>'
		{ 0x02, 0x01, 0x51, 0x09, 0x06 }, // '?'
		{ 0x32, 0x49, 0x79, 0x41, 0x3E }, // '@'
		{ 0x7E, 0x11, 0x11, 0x11, 0x7E }, // 'A'
		{ 0x7F, 0x49, 0x49, 0x49, 0x36 }, // 'B'
		{ 0x3E, 0x41, 0x41, 0x41, 0x22 }, // 'C'
		{ 0x7F, 0x41, 0x41, 0x22, 0x1C }, // 'D'
		{ 0x7F, 0x49, 0x49, 0x49, 0x41 }, // 'E'
		{ 0x7F, 0x09, 0x09, 0x09, 0x01 }, // 'F'
		{ 0x3E, 0x41, 0x49, 0x49, 0x7A }, // 'G'
		{ 0x7F, 0x08, 0x08, 0x08, 0x7F }, // 'H'
		{ 0x00, 0x41, 0x7F, 0x41, 0x00 }, // 'I'
		{ 0x20, 0x40, 0x41, 0x3F, 0x01 }, // 'J'
		{ 0x7F, 0x08, 0x14, 0x22, 0x41 }, // 'K'
		{ 0x7F, 0x40, 0x40, 0x40, 0x40 }, // 'L'
		{ 0x7F, 0x02, 0x0C, 0x02, 0x7F }, // 'M'
		{ 0x7F, 0x04, 0x08, 0x10, 0x7F }, // 'N'
		{ 0x3E, 0x41, 0x41, 0x41, 0x3E }, // 'O'
		{ 0x7F, 0x09, 0x09, 0x09, 0x06 }, // 'P'
		{ 0x3E, 0x41, 0x51, 0x21, 0x5E }, // 'Q'
		{ 0x7F, 0x09, 0x19, 0x29, 0x46 }, // 'R'
		{ 0x46, 0x49, 0x49, 0x49, 0x31 }, // 'S'
		{ 0x01, 0x01, 0x7F, 0x01, 0x01 }, // 'T'
		{ 0x3F, 0x40, 0x40, 0x40, 0x3F }, // 'U'
		{ 0x1F, 0x20, 0x40, 0x20, 0x1F }, // 'V'
		{ 0x3F, 0x40, 0x38, 0x40, 0x3F }, // 'W'
		{ 0x63, 0x14, 0x08, 0x14, 0x63 }, // 'X'
		{ 0x07, 0x08, 0x70, 0x08, 0x07 }, // 'Y'
		{ 0x61, 0x51, 0x49, 0x45, 0x43 }, // 'Z'
		{ 0x00, 0x7F, 0x41, 0x41, 0x00 }, // '['
		{ 0x02, 0x04, 0x08, 0x10, 0x20 }, // '\'
		{ 0x00, 0x41, 0x41, 0x7F, 0x00 }, // ']'
		{ 0x04, 0x02, 0x01, 0x02, 0x04 }, // '^'
		{ 0x40, 0x40, 0x40, 0x40, 0x40 }, // '_'
		{ 0x00, 0x03, 0x07, 0x00, 0x00 }, // '`'
		{ 0x20, 0x54, 0x54, 0x54, 0x78 }, // 'a'
		{ 0x7F, 0x48, 0x44, 0x44, 0x38 }, // 'b'
		{ 0x38, 0x44, 0x44, 0x44, 0x20 }, // 'c'
		{ 0x38, 0x44, 0x44, 0x48, 0x7F }, // 'd'
		{ 0x38, 0x54, 0x54, 0x54, 0x18 }, // 'e'
		{ 0x08, 0x7E, 0x09, 0x01, 0x02 }, // 'f'
		{ 0x0C, 0x52, 0x52, 0x52, 0x3E }, // 'g'
		{ 0x7F, 0x08, 0x04, 0x04, 0x78 }, // 'h'
		{ 0x00, 0x44, 0x7D, 0x40, 0x00 }, // 'i'
		{ 0x20, 0x40, 0x44, 0x3D, 0x00 }, // 'j'
		{ 0x00, 0x7F, 0x10, 0x28, 0x44 }, // 'k'
		{ 0x00, 0x41, 0x7F, 0x40, 0x00 }, // 'l'
		{ 0x7C, 0x04, 0x18, 0x04, 0x78 }, // 'm'
		{ 0x7C, 0x08, 0x04, 0x04, 0x78 }, // 'n'
		{ 0x38, 0x44, 0x44, 0x44, 0x38 }, // 'o'
		{ 0x7C, 0x14, 0x14, 0x14, 0x08 }, // 'p'
		{ 0x08, 0x14, 0x14, 0x18, 0x7C }, // 'q'
		{ 0x7C, 0x08, 0x04, 0x04, 0x08 }, // 'r'
		{ 0x48, 0x54, 0x54, 0x54, 0x20 }, // 's'
		{ 0x04, 0x3F, 0x44, 0x40, 0x20 }, // 't'
		{ 0x3C, 0x40, 0x40, 0x20, 0x7C }, // 'u'
		{ 0x1C, 0x20, 0x40, 0x20, 0x1C }, // 'v'
		{ 0x3C, 0x40, 0x30, 0x40, 0x3C }, // 'w'
		{ 0x44, 0x28, 0x10, 0x28, 0x44 }, // 'x'
		{ 0x0C, 0x50, 0x50, 0x50, 0x3C }, // 'y'
		{ 0x44, 0x64, 0x54, 0x4C, 0x44 }, // 'z'
		{ 0x00, 0x08, 0x36, 0x41, 0x00 }, // '{'
		{ 0x00, 0x00, 0x7F, 0x00, 0x00 }, // '|'
		{ 0x00, 0x41, 0x36, 0x08, 0x00 }, // '}'
		{ 0x08, 0x08, 0x2A, 0x1C, 0x08 }, // 'â†’'
		};

void oled_power() {
	HAL_Delay(20);
	OLED_RES_RESET();
	HAL_Delay(30);
	OLED_RES_SET();
}

void oled_cmd_send(SPI_HandleTypeDef *spi, uint8_t cmd) {
	uint8_t rx = 0;

	OLED_DC_RESET();
	OLED_CS_RESET();
	HAL_SPI_TransmitReceive(spi, &cmd, &rx, sizeof(cmd), 1000);
	OLED_CS_SET();
	OLED_DC_SET();

}

void oled_ram_send_byte(SPI_HandleTypeDef *spi, uint8_t data) {
	uint8_t rx = 0;

	OLED_DC_SET();
	OLED_CS_RESET();
	HAL_SPI_TransmitReceive(spi, &data, &rx, sizeof(data), 1000);
	OLED_CS_SET();
	OLED_DC_RESET();

}

void oled_ram_send(SPI_HandleTypeDef *spi, uint8_t data, uint32_t size) {
	uint8_t rx[size];

	OLED_DC_SET();
	OLED_CS_RESET();
	HAL_SPI_TransmitReceive(spi, &data, rx, size, 100);
	OLED_CS_SET();
	OLED_DC_RESET();

}

void oled_init(SPI_HandleTypeDef *spi) {
	// if dc LOW = cmd, if dc HIGH = ram
	oled_power();
	oled_cmd_send(spi, 0xAE); // Display OFF
	oled_cmd_send(spi, 0x20); // Set Memory Addressing Mode
	oled_cmd_send(spi, 0x00); // Horizontal Addressing Mode

	oled_cmd_send(spi, 0xB0); // Set Page Start Address for Page Addressing Mode
	oled_cmd_send(spi, 0xC8); // COM Output Scan Direction

	oled_cmd_send(spi, 0x00); // Low Column Address
	oled_cmd_send(spi, 0x10); // High Column Address

	oled_cmd_send(spi, 0x40); // Set Start Line Address
	oled_cmd_send(spi, 0x81); // Set Contrast Control
	oled_cmd_send(spi, 0x7F); // Contrast = 127

	oled_cmd_send(spi, 0xA1); // Segment Re-map
	oled_cmd_send(spi, 0xA6); // Normal display

	oled_cmd_send(spi, 0xA8); // Set Multiplex Ratio
	oled_cmd_send(spi, 0x3F); // 1/64 duty

	oled_cmd_send(spi, 0xA4); // Output RAM to Display
	oled_cmd_send(spi, 0xD3); // Display Offset
	oled_cmd_send(spi, 0x00); // No offset

	oled_cmd_send(spi, 0xD5); // Display Clock Divide Ratio
	oled_cmd_send(spi, 0x80); // Suggested ratio

	oled_cmd_send(spi, 0xD9); // Pre-charge Period
	oled_cmd_send(spi, 0xF1);

	oled_cmd_send(spi, 0xDA); // COM Pins Hardware Configuration
	oled_cmd_send(spi, 0x12);

	oled_cmd_send(spi, 0xDB); // VCOMH Deselect Level
	oled_cmd_send(spi, 0x40);

	oled_cmd_send(spi, 0x8D); // Enable charge pump regulator
	oled_cmd_send(spi, 0x14);

	oled_cmd_send(spi, 0xAF); // Display ON

}

void oled_clear(SPI_HandleTypeDef *spi) {
	for (int j = 0; j < PAGE_COUNT; ++j) {
		oled_cmd_send(spi, 0xB0 + j);
		oled_cmd_send(spi, 0x00);
		oled_cmd_send(spi, 0x10);
		for (int i = 0; i < WIDTH; ++i) {
			oled_ram_send_byte(spi, 0x00);
		}
	}
	oled_cmd_send(spi, 0x00);
	oled_cmd_send(spi, 0x10);
	oled_cmd_send(spi, 0xB0);

}

void oled_fill(SPI_HandleTypeDef *spi, uint8_t value) {
	for (int j = 0; j < PAGE_COUNT; ++j) {
		oled_cmd_send_byte(spi, 0xB0 + j);
		oled_cmd_send(spi, 0x00);
		oled_cmd_send(spi, 0x10);
		for (int i = 0; i < WIDTH; ++i) {
			oled_ram_send_byte(spi, value);
		}
	}
	oled_cmd_send(spi, 0x00);
	oled_cmd_send(spi, 0x10);
	oled_cmd_send(spi, 0xB0);
}

int oled_draw_char(SPI_HandleTypeDef *spi, char c) {
	if (c < FIRST_SYMBOL_ID || c > LAST_SYMBOL_ID) {
		return 0;
	} else {
		for (int i = 0; i < SYMBOL_7x4_COLMNS; i++) {
			oled_ram_send_byte(spi, symbols[c - 32][i]);
		}
		oled_ram_send_byte(spi, 0x00);
		return 1;
	}


}

void oled_string_print(SPI_HandleTypeDef *spi, const char *str) {
	for (int i = 0; i < strlen(str); ++i) {
		oled_draw_char(spi, str[i]);
	}
}

void oled_string_println(SPI_HandleTypeDef *spi, const char *str) {
	for (int i = 0; i < strlen(str); ++i) {
		oled_draw_char(spi, str[i]);
	}
	oled_cmd_send(spi, 0x00);
	oled_cmd_send(spi, 0x10);
	oled_cmd_send(spi, 0xB0 + 1);
}
